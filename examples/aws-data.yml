name: aws-data

description: Collects EC2, S3, Route53 data from multiple accounts / multiple regions

configure-aws-accounts:
  runner: json-config
  items:
    - acceptance:
        accessKeyId: ${env.AWS_ACCESS_KEY_ACCEPTANCE}
        secretAccessKey: ${env.AWS_SECRET_KEY_ACCEPTANCE}
        extendMessage:
          source: "aws"
          account: "redapple.acceptance"
          customer: "red apple"
    - production:
        accessKey: ${env.AWS_ACCESS_KEY_PRODUCTION}
        secretKey: ${env.AWS_SECRET_KEY_PRODUCTION}
        extendMessage:
          source: "aws"
          account: "redapple.production"
          customer: "red apple"

configure-aws-regions:
  runner: json-config
  items:
    - ireland:
        region: eu-west-1
        extendMessage:
          region: eu-west-1
    - london:
        region: eu-west-2
        extendMessage:
          region: eu-west-2
    - frankfurt:
        region: eu-central-1
        extendMessage:
          region: eu-central-1

collect-ec2:
  runner: aws-origin.EC2.describeInstances
  transform:
    - jsonpath: $.Reservations..Instances.*
    - reduce: count
  extendMessage:
    resource: "aws.ec2.instances.all.count"

collect-s3:
  runner: aws-origin.S3.describeBuckets
  transform:
    - jsonpath: "TODO: list of buckets"
    - reduce: count
  extendMessage:
    resource: "aws.s3.buckets.all.count"

push-to-kinesis:
  runner: aws-destination.kinesis.putRecords
  extendMessage:
    _meta:
      eventType: "public-cloud-record"
      producedBy: "datapull.v1"
      timestamp: ${pipeline.timestamp}
    period: ${customFunctions.monthYear()}
    quantity: ${data}

